# JDSF 路由功能实现原理

## 服务路由概述

&emsp;&emsp;用户在使用 JDSF 运行自己的业务时，由于业务的复杂程度，经常需要部署数目庞大的服务实例运行在当前网络环境中。这些服务运行在属性不同的实例上、部署在不同的地域中，用户经常需要根据符合自己特定要求的属性选择服务的提供者，对服务间流量的分配起到掌控的作用。  
&emsp;&emsp;同时，在微服务的场景下，用户研发新版本上线的迭代周期越来越快，稳定敏捷的上线新版本需要微服务框架能够支持灰度发布、金丝雀发布、滚动发布等发布方式。通过服务路由功能，用户可以配置流量分配权重，设置某些权重的流量被分配到某个版本号中，为灰度发布等上线模式提供了无需终止服务的底层能力支持。为了保证满足客户的定制化需求，JDSF定制了一些常用场景的标签，可以在使用 spring cloud 框架的情况下，定向分配流量。 总而言之，服务路由功能的主要作用是将调用流量按照自己的需求进行分配。

## 路由功能原理

要实现服务路由需要完成三部分操作：

* 在服务启动的时候为服务设置一些元数据，保障这些元数据在选取服务的时候能够获取到这些元数据，目前这些原数据只有使用微服务平台部署的时候回自动的注入。
* 控制台上面给服务的客户端（消费者）设置路由规则
* 当服务启动后客户端获取到路由规则的时候会根据流量来源方规则进行匹配判断当前规则是否对自己生效
  
以常见的在线商店下单为例，现在有 order->goods->user调用模式，当用户下单的时候，会先去获取商品的信息，商品会去调用用户服务获取当前用户是否可以购买当前商品，可以购买当前商品的数量限制。最后确认用户是否可以购买当前商品。

* order: Spring Cloud 应用，使用路由 sdk  
* goods:  Spring Cloud 应用 ，使用路由 sdk  ，有 v1 和 v2-beta两个版本
* user: Spring Cloud 应用，有 v1 和 v2-beta两个版本
  
服务调用和路由情况如下图所示。用户需要在控制台创建如下路由规则：

* order 服务详情页中配置路由规则：90%的流量分配到 goods v1 版本，10%的流量分配到goods v2-beta 版本。
* goods 服务详情页中配置路由规则：如果当前服务的版本为 v1时，当请求 user 服务的时候100%分配到 user v1 版本，如果当前服务的版本为 v2-beta 时，当请求user服务的时候 100% 请求到user 的 v2-beta 版本。